<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPX Event Intelligence ‚Äî Finansal Performans Sistemi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-void: #060a12;
    --bg-base: #0b1120;
    --bg-surface: #111827;
    --bg-elevated: #1a2438;
    --bg-card: #1e2d45;
    --bg-hover: #243352;
    --accent-primary: #3b82f6;
    --accent-glow: #60a5fa;
    --accent-cyan: #22d3ee;
    --accent-emerald: #10b981;
    --accent-amber: #f59e0b;
    --accent-rose: #f43f5e;
    --accent-violet: #8b5cf6;
    --text-primary: #f0f4ff;
    --text-secondary: #8da0bf;
    --text-muted: #4d6080;
    --border-subtle: rgba(59,130,246,0.12);
    --border-accent: rgba(59,130,246,0.3);
    --grid-line: rgba(59,130,246,0.06);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-void);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid-line) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app-container { position: relative; z-index: 1; display: flex; min-height: 100vh; }

  /* SIDEBAR */
  .sidebar {
    width: 220px;
    min-height: 100vh;
    background: var(--bg-surface);
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0; left: 0;
    z-index: 100;
    padding: 24px 0;
  }

  .sidebar-logo {
    padding: 0 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .logo-mark {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 22px;
    color: var(--text-primary);
    letter-spacing: -0.5px;
  }

  .logo-sub {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--accent-primary);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .nav-section {
    padding: 20px 0;
    flex: 1;
  }

  .nav-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 0 20px;
    margin-bottom: 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 400;
    border-left: 2px solid transparent;
  }

  .nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
  .nav-item.active {
    background: rgba(59,130,246,0.1);
    color: var(--accent-glow);
    border-left-color: var(--accent-primary);
  }

  .nav-icon { font-size: 14px; width: 16px; text-align: center; }

  /* MAIN */
  .main-content {
    margin-left: 220px;
    flex: 1;
    padding: 0;
    min-height: 100vh;
  }

  /* TOPBAR */
  .topbar {
    background: rgba(11,17,32,0.8);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-subtle);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .topbar-right { display: flex; gap: 12px; align-items: center; }

  .filter-group { display: flex; gap: 8px; }

  .filter-select {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    color: var(--text-secondary);
    padding: 7px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }

  .filter-select:hover { border-color: var(--border-accent); }

  .btn-primary {
    background: var(--accent-primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .btn-primary:hover { background: var(--accent-glow); transform: translateY(-1px); }

  .btn-secondary {
    background: var(--bg-elevated);
    color: var(--text-secondary);
    border: 1px solid var(--border-subtle);
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }

  .btn-secondary:hover { border-color: var(--border-accent); color: var(--text-primary); }

  /* PAGES */
  .page { display: none; padding: 28px 32px; }
  .page.active { display: block; }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .kpi-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .kpi-card:hover { border-color: var(--border-accent); }

  .kpi-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 60px; height: 60px;
    border-radius: 0 12px 0 100%;
    opacity: 0.08;
  }

  .kpi-card.blue::after { background: var(--accent-primary); }
  .kpi-card.emerald::after { background: var(--accent-emerald); }
  .kpi-card.amber::after { background: var(--accent-amber); }
  .kpi-card.rose::after { background: var(--accent-rose); }
  .kpi-card.violet::after { background: var(--accent-violet); }
  .kpi-card.cyan::after { background: var(--accent-cyan); }

  .kpi-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .kpi-value {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 6px;
  }

  .kpi-sub {
    font-size: 11px;
    color: var(--text-muted);
  }

  .kpi-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    font-family: 'DM Mono', monospace;
  }

  .badge-pos { background: rgba(16,185,129,0.15); color: var(--accent-emerald); }
  .badge-neg { background: rgba(244,63,94,0.15); color: var(--accent-rose); }
  .badge-neu { background: rgba(59,130,246,0.15); color: var(--accent-glow); }

  /* CHART GRID */
  .chart-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .chart-grid-3 {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .chart-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .chart-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .chart-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .chart-wrapper { position: relative; height: 220px; }
  .chart-wrapper.tall { height: 280px; }

  /* TABLE */
  .table-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-head {
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-subtle);
  }

  .table-head-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
  }

  .search-input {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 7px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    width: 200px;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--border-accent); }
  .search-input::placeholder { color: var(--text-muted); }

  table { width: 100%; border-collapse: collapse; }

  thead tr {
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border-subtle);
  }

  th {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    font-weight: 500;
    color: var(--text-muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 10px 16px;
    text-align: left;
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border-subtle);
    transition: background 0.15s;
    cursor: pointer;
  }

  tbody tr:hover { background: var(--bg-elevated); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 10px 16px;
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  td.name-col { color: var(--text-primary); font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
  td.num { font-family: 'DM Mono', monospace; font-size: 11px; }
  td.pos { color: var(--accent-emerald); }
  td.neg { color: var(--accent-rose); }

  .pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
  }

  .pill-high { background: rgba(16,185,129,0.15); color: var(--accent-emerald); }
  .pill-mid { background: rgba(245,158,11,0.15); color: var(--accent-amber); }
  .pill-low { background: rgba(244,63,94,0.15); color: var(--accent-rose); }

  /* FORM */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }

  .form-group { display: flex; flex-direction: column; gap: 6px; }

  .form-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .form-input {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }

  .form-input:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  .form-input::placeholder { color: var(--text-muted); }

  .form-divider {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    color: var(--accent-primary);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 8px 0;
    padding: 6px 0;
    border-top: 1px solid var(--border-subtle);
    border-bottom: 1px solid var(--border-subtle);
  }

  .computed-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .computed-item { text-align: center; }
  .computed-label { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .computed-value { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }
  .cv-blue { color: var(--accent-glow); }
  .cv-emerald { color: var(--accent-emerald); }
  .cv-amber { color: var(--accent-amber); }
  .cv-rose { color: var(--accent-rose); }

  /* WEATHER */
  .weather-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .weather-status {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .weather-icon { font-size: 28px; }

  .weather-detail { font-size: 12px; color: var(--text-secondary); line-height: 1.8; }
  .weather-detail strong { color: var(--text-primary); font-family: 'DM Mono', monospace; }

  .gemini-prompt {
    background: rgba(59,130,246,0.05);
    border: 1px solid rgba(59,130,246,0.15);
    border-radius: 8px;
    padding: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-top: 10px;
  }

  /* ANALYSIS */
  .insight-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .insight-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 20px;
  }

  .insight-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .insight-icon {
    width: 32px; height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .ii-blue { background: rgba(59,130,246,0.15); }
  .ii-emerald { background: rgba(16,185,129,0.15); }
  .ii-amber { background: rgba(245,158,11,0.15); }
  .ii-rose { background: rgba(244,63,94,0.15); }

  .insight-title { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; }

  .insight-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 12px;
  }

  .insight-row:last-child { border-bottom: none; }
  .ir-label { color: var(--text-secondary); }
  .ir-bar-wrap { flex: 1; margin: 0 12px; height: 3px; background: var(--bg-elevated); border-radius: 2px; }
  .ir-bar { height: 100%; border-radius: 2px; }
  .ir-val { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-primary); font-weight: 500; }

  /* SECTION HEADER */
  .section-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--accent-primary);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 20px;
    letter-spacing: -0.5px;
  }

  .section-header {
    margin-bottom: 20px;
  }

  /* STATUS indicator */
  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }

  .dot-green { background: var(--accent-emerald); box-shadow: 0 0 6px var(--accent-emerald); }
  .dot-blue { background: var(--accent-primary); box-shadow: 0 0 6px var(--accent-primary); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(6,10,18,0.8);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-accent);
    border-radius: 16px;
    padding: 28px;
    max-width: 560px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
  }

  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-close {
    cursor: pointer;
    color: var(--text-muted);
    font-size: 18px;
    transition: color 0.2s;
  }

  .modal-close:hover { color: var(--text-primary); }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--bg-elevated);
    border: 1px solid var(--accent-emerald);
    color: var(--accent-emerald);
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s;
  }

  .toast.show { opacity: 1; transform: translateY(0); }

  /* responsive scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-base); }
  ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }

  .year-tab {
    padding: 5px 12px;
    border-radius: 5px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    cursor: pointer;
    border: 1px solid var(--border-subtle);
    color: var(--text-muted);
    background: transparent;
    transition: all 0.2s;
  }

  .year-tab.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    font-size: 13px;
  }
</style>
</head>
<body>

<div class="app-container">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">SPX<span style="color:var(--accent-primary)">.</span></div>
      <div class="logo-sub">Event Intelligence</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Ana Men√º</div>
      <div class="nav-item active" onclick="showPage('dashboard', this)">
        <span class="nav-icon">‚óà</span> Dashboard
      </div>
      <div class="nav-item" onclick="showPage('events', this)">
        <span class="nav-icon">‚óâ</span> Etkinlikler
      </div>
      <div class="nav-item" onclick="showPage('new-event', this)">
        <span class="nav-icon">+</span> Yeni Etkinlik
      </div>
      <div class="nav-label" style="margin-top:16px">Analiz</div>
      <div class="nav-item" onclick="showPage('analysis', this)">
        <span class="nav-icon">‚ñ£</span> Analiz Motoru
      </div>
      <div class="nav-item" onclick="showPage('weather', this)">
        <span class="nav-icon">‚óé</span> Hava Durumu
      </div>
    </div>
    <div style="padding: 16px 20px; border-top: 1px solid var(--border-subtle);">
      <div style="font-size:10px; color:var(--text-muted); font-family:'DM Mono',monospace; line-height:1.6;">
        <span class="status-dot dot-green"></span>Sƒ∞STEM AKTƒ∞F<br>
        <span style="margin-left:10px">v2.1.0 ‚Äî 2025</span>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main-content">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="page-title" id="page-title">Dashboard ‚Äî Genel Bakƒ±≈ü</div>
      <div class="topbar-right">
        <div class="filter-group">
          <select class="filter-select" id="year-filter" onchange="applyFilters()">
            <option value="all">T√ºm Yƒ±llar</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
          <select class="filter-select" id="city-filter" onchange="applyFilters()">
            <option value="all">T√ºm ≈ûehirler</option>
          </select>
        </div>
        <button class="btn-secondary" onclick="exportCSV()">‚Üì CSV</button>
        <button class="btn-primary" onclick="showPage('new-event', document.querySelector('.nav-item:nth-child(3)'))">+ Ekle</button>
      </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="page active" id="page-dashboard">
      <div class="section-header">
        <div class="section-label">Genel Bakƒ±≈ü</div>
        <div class="section-title">Finansal Performans Dashboard</div>
      </div>

      <!-- KPI Row 1 -->
      <div class="kpi-grid">
        <div class="kpi-card blue">
          <div class="kpi-label">Toplam Ciro</div>
          <div class="kpi-value" id="kpi-ciro">‚Ç∫0</div>
          <div class="kpi-sub"><span class="kpi-badge badge-pos" id="kpi-ciro-badge">‚Äî</span></div>
        </div>
        <div class="kpi-card emerald">
          <div class="kpi-label">Toplam Net Kar</div>
          <div class="kpi-value" id="kpi-kar">‚Ç∫0</div>
          <div class="kpi-sub"><span class="kpi-badge badge-pos" id="kpi-kar-badge">‚Äî</span></div>
        </div>
        <div class="kpi-card amber">
          <div class="kpi-label">Toplam Gider</div>
          <div class="kpi-value" id="kpi-gider">‚Ç∫0</div>
          <div class="kpi-sub" id="kpi-gider-sub">‚Äî</div>
        </div>
        <div class="kpi-card violet">
          <div class="kpi-label">Ort. Kar Marjƒ±</div>
          <div class="kpi-value" id="kpi-margin">%0</div>
          <div class="kpi-sub" id="kpi-margin-sub">‚Äî</div>
        </div>
      </div>

      <div class="kpi-grid" style="grid-template-columns: repeat(4,1fr)">
        <div class="kpi-card cyan">
          <div class="kpi-label">Etkinlik Sayƒ±sƒ±</div>
          <div class="kpi-value" id="kpi-count">0</div>
          <div class="kpi-sub" id="kpi-count-sub">‚Äî</div>
        </div>
        <div class="kpi-card emerald">
          <div class="kpi-label">En Karlƒ± Etkinlik</div>
          <div class="kpi-value" style="font-size:13px; padding-top:4px" id="kpi-best">‚Äî</div>
          <div class="kpi-sub" id="kpi-best-val">‚Äî</div>
        </div>
        <div class="kpi-card rose">
          <div class="kpi-label">En D√º≈ü√ºk Performans</div>
          <div class="kpi-value" style="font-size:13px; padding-top:4px" id="kpi-worst">‚Äî</div>
          <div class="kpi-sub" id="kpi-worst-val">‚Äî</div>
        </div>
        <div class="kpi-card blue">
          <div class="kpi-label">Ortalama ROI</div>
          <div class="kpi-value" id="kpi-roi">%0</div>
          <div class="kpi-sub" id="kpi-roi-sub">‚Äî</div>
        </div>
      </div>

      <!-- Charts Row 1 -->
      <div class="chart-grid-3">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Aylƒ±k Ciro & Kar Trendi</div>
              <div class="chart-sub">Se√ßili d√∂nem bazƒ±nda</div>
            </div>
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartMonthly"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">≈ûehre G√∂re ROI</div>
              <div class="chart-sub">Konum bazlƒ± kar≈üƒ±la≈ütƒ±rma</div>
            </div>
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartCityROI"></canvas>
          </div>
        </div>
      </div>

      <!-- Charts Row 2 -->
      <div class="chart-grid-2">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Etkinlik Bazlƒ± Karlƒ±lƒ±k</div>
              <div class="chart-sub">Ciro vs Gider kar≈üƒ±la≈ütƒ±rmasƒ±</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartEventProfit"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Gider Daƒüƒ±lƒ±mƒ±</div>
              <div class="chart-sub">Maliyet kalemleri</div>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartExpense"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- EVENTS PAGE -->
    <div class="page" id="page-events">
      <div class="section-header">
        <div class="section-label">Etkinlik Y√∂netimi</div>
        <div class="section-title">T√ºm Etkinlikler</div>
      </div>
      <div class="table-card">
        <div class="table-head">
          <div class="table-head-title">Etkinlik Listesi <span id="event-count-badge" style="font-size:11px;color:var(--text-muted);font-family:'DM Mono',monospace"></span></div>
          <div style="display:flex;gap:8px">
            <input type="text" class="search-input" placeholder="Etkinlik ara..." oninput="filterTable(this.value)">
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>ETKƒ∞NLƒ∞K</th>
                <th>TARƒ∞H</th>
                <th>≈ûEHƒ∞R</th>
                <th>KATILIMCI</th>
                <th>TOPLAM Cƒ∞RO</th>
                <th>TOPLAM Gƒ∞DER</th>
                <th>NET KAR</th>
                <th>KAR MARJI</th>
                <th>ROI</th>
                <th>KAT. BA≈ûI Cƒ∞RO</th>
                <th>KAT. BA≈ûI MALƒ∞YET</th>
                <th>PERFORMANS</th>
              </tr>
            </thead>
            <tbody id="events-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- NEW EVENT PAGE -->
    <div class="page" id="page-new-event">
      <div class="section-header">
        <div class="section-label">Veri Giri≈üi</div>
        <div class="section-title">Yeni Etkinlik Ekle</div>
      </div>

      <div class="chart-card" style="margin-bottom:20px">
        <div class="form-divider">‚Äî Etkinlik Bilgileri</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Etkinlik Adƒ±</label>
            <input type="text" class="form-input" id="f-name" placeholder="ƒ∞zmir Maratonu 2025">
          </div>
          <div class="form-group">
            <label class="form-label">Tarih</label>
            <input type="date" class="form-input" id="f-date">
          </div>
          <div class="form-group">
            <label class="form-label">≈ûehir</label>
            <input type="text" class="form-input" id="f-city" placeholder="ƒ∞zmir">
          </div>
          <div class="form-group">
            <label class="form-label">Katƒ±lƒ±mcƒ± Sayƒ±sƒ±</label>
            <input type="number" class="form-input" id="f-katilimci" placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label">√áadƒ±r Sayƒ±sƒ±</label>
            <input type="number" class="form-input" id="f-cadƒ±r" placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label">Yƒ±l</label>
            <select class="form-input" id="f-year">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
            </select>
          </div>
        </div>

        <div class="form-divider">‚Äî Gider Kalemleri</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Ajans Bedeli (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-ajans" placeholder="0" oninput="calcPreview()">
          </div>
          <div class="form-group">
            <label class="form-label">Personel Gideri (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-personel" placeholder="0" oninput="calcPreview()">
          </div>
          <div class="form-group">
            <label class="form-label">Stand Maliyeti (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-stand" placeholder="0" oninput="calcPreview()">
          </div>
          <div class="form-group">
            <label class="form-label">Barter (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-barter" placeholder="0" oninput="calcPreview()">
          </div>
        </div>

        <div class="form-divider">‚Äî Ciro Kalemleri</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">√áek Ciro (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-cek" placeholder="0" oninput="calcPreview()">
          </div>
          <div class="form-group">
            <label class="form-label">√áadƒ±r Ciro (‚Ç∫)</label>
            <input type="number" class="form-input" id="f-cadirciro" placeholder="0" oninput="calcPreview()">
          </div>
        </div>

        <!-- Computed preview -->
        <div class="form-divider">‚Äî Anlƒ±k Hesaplama</div>
        <div class="computed-grid">
          <div class="computed-item">
            <div class="computed-label">Toplam Ciro</div>
            <div class="computed-value cv-blue" id="p-ciro">‚Ç∫0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">Toplam Gider</div>
            <div class="computed-value cv-amber" id="p-gider">‚Ç∫0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">Net Kar</div>
            <div class="computed-value cv-emerald" id="p-kar">‚Ç∫0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">Kar Marjƒ±</div>
            <div class="computed-value cv-blue" id="p-margin">%0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">ROI</div>
            <div class="computed-value cv-emerald" id="p-roi">%0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">Kat. Ba≈üƒ± Ciro</div>
            <div class="computed-value cv-blue" id="p-perciro">‚Ç∫0</div>
          </div>
          <div class="computed-item">
            <div class="computed-label">Kat. Ba≈üƒ± Maliyet</div>
            <div class="computed-value cv-amber" id="p-pergider">‚Ç∫0</div>
          </div>
        </div>

        <!-- Weather section -->
        <div class="form-divider">‚Äî Hava Durumu (Gemini AI)</div>
        <div class="weather-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div style="font-size:12px;color:var(--text-secondary)">Gemini'ye ≈üu prompt g√∂nderilecek:</div>
            <button class="btn-secondary" onclick="fetchWeather()" style="font-size:11px">Prompt Olu≈ütur</button>
          </div>
          <div class="gemini-prompt" id="weather-prompt">Tarih ve ≈üehir girerek prompt olu≈üturun...</div>
          <div style="margin-top:12px;display:flex;align-items:center;gap:12px" id="weather-result" style="display:none">
            <div>
              <div class="form-label" style="margin-bottom:6px">Gemini Yanƒ±tƒ±nƒ± Yapƒ±≈ütƒ±r</div>
              <textarea class="form-input" id="f-weather" rows="4" style="resize:vertical;font-family:'DM Mono',monospace;font-size:11px" placeholder="Sƒ±caklƒ±k: 22¬∞C&#10;Durum: G√ºne≈üli&#10;R√ºzgar: 15 km/h"></textarea>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="clearForm()">Temizle</button>
          <button class="btn-primary" onclick="saveEvent()">‚úì Etkinliƒüi Kaydet</button>
        </div>
      </div>
    </div>

    <!-- ANALYSIS PAGE -->
    <div class="page" id="page-analysis">
      <div class="section-header">
        <div class="section-label">Karar Destek Sistemi</div>
        <div class="section-title">Analiz Motoru</div>
      </div>

      <div class="insight-grid">
        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-icon ii-emerald">üèÜ</div>
            <div class="insight-title">≈ûehir Bazlƒ± Karlƒ±lƒ±k</div>
          </div>
          <div id="city-analysis"></div>
        </div>
        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-icon ii-blue">üìä</div>
            <div class="insight-title">Ajans Maliyeti vs Kar Marjƒ±</div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartAgencyMargin"></canvas>
          </div>
        </div>
        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-icon ii-amber">üë•</div>
            <div class="insight-title">Katƒ±lƒ±mcƒ± Artƒ±≈üƒ± & ROI ƒ∞li≈ükisi</div>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartParticipantROI"></canvas>
          </div>
        </div>
        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-icon ii-rose">üå§</div>
            <div class="insight-title">Hava Durumu & Performans</div>
          </div>
          <div id="weather-analysis">
            <div class="empty-state" style="padding:20px">
              <div style="font-size:24px;margin-bottom:8px">‚òÅÔ∏è</div>
              Hava durumu verisi girdik√ße burada g√∂r√ºnecek
            </div>
          </div>
        </div>
      </div>

      <!-- Decision Support -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Karar Destek √ñzeti</div>
            <div class="chart-sub">Veri odaklƒ± √∂neriler</div>
          </div>
        </div>
        <div id="decision-support" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:8px"></div>
      </div>
    </div>

    <!-- WEATHER PAGE -->
    <div class="page" id="page-weather">
      <div class="section-header">
        <div class="section-label">Hava Durumu Analizi</div>
        <div class="section-title">Gemini AI Entegrasyonu</div>
      </div>
      <div class="chart-card" style="margin-bottom:20px">
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;margin-bottom:16px">
          Gemini'ye g√∂ndermeniz gereken format:
        </div>
        <div style="background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:10px;padding:20px">
          <div style="font-family:'DM Mono',monospace;font-size:12px;line-height:2;color:var(--text-secondary)">
            <span style="color:var(--accent-amber)">PROMPT ≈ûABLONU</span><br><br>
            "<span style="color:var(--text-primary)">[TARƒ∞H] tarihinde [≈ûEHƒ∞R]'de hava nasƒ±ldƒ±?</span><br>
            Sadece ≈üu formatta cevap ver:<br>
            Sƒ±caklƒ±k: X¬∞C<br>
            Durum: G√ºne≈üli/Yaƒümurlu/Bulutlu<br>
            R√ºzgar: X km/h"
          </div>
        </div>
        <div style="margin-top:16px;font-size:12px;color:var(--text-muted)">
          ‚ÑπÔ∏è Yanƒ±tƒ± kopyalayƒ±p Yeni Etkinlik > Hava Durumu b√∂l√ºm√ºne yapƒ±≈ütƒ±rƒ±n.
        </div>
      </div>

      <div class="table-card">
        <div class="table-head">
          <div class="table-head-title">Hava Durumu Kayƒ±tlarƒ±</div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>ETKƒ∞NLƒ∞K</th>
                <th>TARƒ∞H</th>
                <th>≈ûEHƒ∞R</th>
                <th>SICAKLIK</th>
                <th>DURUM</th>
                <th>R√úZGAR</th>
                <th>NET KAR</th>
                <th>ETKƒ∞</th>
              </tr>
            </thead>
            <tbody id="weather-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-title">
      <span id="modal-event-name">Etkinlik Detayƒ±</span>
      <span class="modal-close" onclick="closeModal()">‚úï</span>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const EVENTS_2024 = [
  { id:1, name:'ƒ∞zmir Maratonu', date:'2024-04-21', city:'ƒ∞zmir', participants:5759, tents:0, agency:47300, personnel:12910, standCost:80000, barter:0, cekCiro:0, cadirCiro:161621, year:2024, weather:'' },
  { id:2, name:'Merrell Tahtalƒ± Run To Sky', date:'2024-11-05', city:'Antalya', participants:825, tents:0, agency:0, personnel:3651, standCost:0, barter:0, cekCiro:53683, cadirCiro:348600, year:2024, weather:'' },
  { id:3, name:'Spx Daƒüyenice Ultra', date:'2024-05-24', city:'Bursa', participants:980, tents:0, agency:0, personnel:6760, standCost:0, barter:0, cekCiro:11493, cadirCiro:227000, year:2024, weather:'' },
  { id:4, name:'Granfondo Bursa', date:'2024-05-26', city:'Bursa', participants:600, tents:0, agency:13500, personnel:500, standCost:0, barter:12000, cekCiro:13941, cadirCiro:23000, year:2024, weather:'' },
  { id:5, name:'Wolfest', date:'2024-05-31', city:'Kocaeli', participants:0, tents:0, agency:0, personnel:0, standCost:0, barter:0, cekCiro:0, cadirCiro:236200, year:2024, weather:'' },
  { id:6, name:'SPX Pickleball ƒ∞stanbul Cup', date:'2024-06-06', city:'ƒ∞stanbul', participants:80, tents:0, agency:0, personnel:7500, standCost:0, barter:0, cekCiro:14424, cadirCiro:0, year:2024, weather:'' },
  { id:7, name:'Spx Uludaƒü Bisiklet Tƒ±rmanƒ±≈üƒ±', date:'2024-08-03', city:'Bursa', participants:458, tents:0, agency:33500, personnel:4850, standCost:0, barter:0, cekCiro:1226, cadirCiro:0, year:2024, weather:'' },
  { id:8, name:'Uludaƒü Ultra Trail', date:'2024-07-13', city:'Bursa', participants:2620, tents:0, agency:38500, personnel:28000, standCost:60000, barter:0, cekCiro:0, cadirCiro:160167, year:2024, weather:'' },
  { id:9, name:'Eski≈üehir Yarƒ± Maratonu', date:'2024-08-25', city:'Eski≈üehir', participants:1850, tents:5, agency:38500, personnel:11440, standCost:0, barter:50000, cekCiro:40833, cadirCiro:110266, year:2024, weather:'' },
  { id:10, name:'Bursa Pickleball Turnuvasƒ±', date:'2024-08-24', city:'Bursa', participants:75, tents:0, agency:28102, personnel:9500, standCost:0, barter:0, cekCiro:0, cadirCiro:0, year:2024, weather:'' },
  { id:11, name:'Merrell Belgrad Ultra', date:'2024-07-09', city:'ƒ∞stanbul', participants:2590, tents:0, agency:0, personnel:27764, standCost:0, barter:0, cekCiro:0, cadirCiro:343386, year:2024, weather:'' },
  { id:12, name:'Kyzikos Ultra Trail', date:'2024-09-21', city:'Erdek', participants:1100, tents:0, agency:44110, personnel:35664, standCost:0, barter:0, cekCiro:0, cadirCiro:144000, year:2024, weather:'' },
  { id:13, name:'Ankara Kahve Festivali', date:'2024-09-20', city:'Ankara', participants:35000, tents:0, agency:0, personnel:500, standCost:0, barter:50000, cekCiro:62630, cadirCiro:0, year:2024, weather:'' },
  { id:14, name:'Spx Pickleball ƒ∞zmir Cup', date:'2024-10-11', city:'ƒ∞zmir', participants:90, tents:0, agency:0, personnel:78000, standCost:0, barter:0, cekCiro:25436, cadirCiro:0, year:2024, weather:'' },
  { id:15, name:'Salomon Cappadocia Ultra', date:'2024-10-19', city:'Nev≈üehir', participants:3500, tents:4, agency:48500, personnel:72000, standCost:100000, barter:0, cekCiro:0, cadirCiro:517000, year:2024, weather:'' },
  { id:16, name:'Kurumsal K√ºrek Yarƒ±≈üƒ±', date:'2024-02-11', city:'Bursa', participants:350, tents:0, agency:0, personnel:1200, standCost:0, barter:0, cekCiro:3500, cadirCiro:10000, year:2024, weather:'' },
  { id:17, name:'Antalya Ultra', date:'2024-12-28', city:'Antalya', participants:950, tents:0, agency:43296, personnel:15180, standCost:30000, barter:0, cekCiro:0, cadirCiro:181419, year:2024, weather:'' },
];

const EVENTS_2025 = [
  { id:100, name:'Efes Ultra Maratonu', date:'2025-04-04', city:'ƒ∞zmir', participants:2180, tents:6, agency:60000, personnel:49460, standCost:30000, barter:0, cekCiro:0, cadirCiro:658000, year:2025, weather:'' },
  { id:101, name:'SPX Pickleball Ligi (Nisan/ƒ∞st)', date:'2025-04-12', city:'ƒ∞stanbul', participants:60, tents:0, agency:0, personnel:6039, standCost:0, barter:0, cekCiro:0, cadirCiro:0, year:2025, weather:'' },
  { id:102, name:'Troya Yarƒ± Maratonu', date:'2025-04-19', city:'√áanakkale', participants:2500, tents:8, agency:140100, personnel:27996, standCost:0, barter:0, cekCiro:87011, cadirCiro:1014904, year:2025, weather:'' },
  { id:103, name:'SPX Pickleball Ligi (Nisan/Ank)', date:'2025-04-26', city:'Ankara', participants:0, tents:0, agency:0, personnel:1000, standCost:0, barter:0, cekCiro:0, cadirCiro:0, year:2025, weather:'' },
  { id:104, name:'Tahtalƒ± Run To Sky', date:'2025-05-10', city:'Antalya', participants:300, tents:0, agency:0, personnel:0, standCost:36000, barter:0, cekCiro:0, cadirCiro:126000, year:2025, weather:'' },
  { id:105, name:'SPX Tenis Turnuvasƒ±', date:'2025-05-17', city:'Antalya', participants:600, tents:0, agency:106774, personnel:0, standCost:0, barter:0, cekCiro:111915, cadirCiro:0, year:2025, weather:'' },
  { id:106, name:'KTSK ≈ûenlikleri', date:'2025-05-23', city:'ƒ∞stanbul', participants:10000, tents:0, agency:103000, personnel:0, standCost:0, barter:0, cekCiro:0, cadirCiro:1185749, year:2025, weather:'' },
  { id:107, name:'Sapanca Ultra', date:'2025-06-14', city:'Sakarya', participants:1000, tents:0, agency:120000, personnel:35596, standCost:0, barter:0, cekCiro:0, cadirCiro:220733, year:2025, weather:'' },
  { id:108, name:'KTSK En Uzun Gece', date:'2025-06-20', city:'ƒ∞stanbul', participants:3000, tents:0, agency:162000, personnel:30500, standCost:0, barter:0, cekCiro:0, cadirCiro:526000, year:2025, weather:'' },
  { id:109, name:'SPX Pickleball Ligi Finalleri', date:'2025-06-28', city:'ƒ∞stanbul', participants:90, tents:0, agency:145080, personnel:35000, standCost:0, barter:0, cekCiro:106000, cadirCiro:0, year:2025, weather:'' },
  { id:110, name:'YKB Ankara Yaz ≈ûenlikleri', date:'2025-07-05', city:'Ankara', participants:450, tents:0, agency:147912, personnel:2950, standCost:0, barter:0, cekCiro:0, cadirCiro:25000, year:2025, weather:'' },
  { id:111, name:'YKB Bankacƒ±lƒ±k √úss√º', date:'2025-07-16', city:'Kocaeli', participants:500, tents:0, agency:90000, personnel:34371, standCost:0, barter:0, cekCiro:0, cadirCiro:261220, year:2025, weather:'' },
  { id:112, name:'Uludaƒü Ultra Trail Yarƒ±≈üƒ±', date:'2025-07-18', city:'Bursa', participants:2500, tents:0, agency:114000, personnel:44000, standCost:100000, barter:0, cekCiro:0, cadirCiro:462762, year:2025, weather:'' },
  { id:113, name:'Eski≈üehir Yarƒ± Maratonu 2025', date:'2025-08-02', city:'Eski≈üehir', participants:2400, tents:0, agency:131700, personnel:29580, standCost:0, barter:54000, cekCiro:0, cadirCiro:222000, year:2025, weather:'' },
  { id:114, name:'Gran Fondo Ba≈ükent Bisiklet', date:'2025-08-23', city:'Ankara', participants:900, tents:0, agency:0, personnel:3800, standCost:0, barter:0, cekCiro:0, cadirCiro:39000, year:2025, weather:'' },
  { id:115, name:'Summer Run', date:'2025-08-30', city:'ƒ∞stanbul', participants:1150, tents:0, agency:48000, personnel:24555, standCost:120000, barter:0, cekCiro:0, cadirCiro:70826, year:2025, weather:'' },
  { id:116, name:'Merrell Belgrad Ultra 2025', date:'2025-09-05', city:'ƒ∞stanbul', participants:3500, tents:0, agency:0, personnel:30132, standCost:0, barter:0, cekCiro:0, cadirCiro:400375, year:2025, weather:'' },
  { id:117, name:'Tuzla Fest Run', date:'2025-09-19', city:'ƒ∞stanbul', participants:1200, tents:0, agency:79200, personnel:22494, standCost:30000, barter:40000, cekCiro:0, cadirCiro:87526, year:2025, weather:'' },
  { id:118, name:'Runkara Yarƒ± Maratonu', date:'2025-10-04', city:'Ankara', participants:3300, tents:0, agency:108000, personnel:9435, standCost:40000, barter:60000, cekCiro:0, cadirCiro:0, year:2025, weather:'' },
  { id:119, name:'Salomon Kapadokya Yarƒ±≈üƒ±', date:'2025-10-16', city:'Nev≈üehir', participants:3500, tents:0, agency:146400, personnel:117600, standCost:120000, barter:0, cekCiro:0, cadirCiro:738000, year:2025, weather:'' },
];

let allEvents = [...EVENTS_2024, ...EVENTS_2025];
let charts = {};
let nextId = 200;

// ============================================================
// COMPUTE METRICS
// ============================================================
function compute(ev) {
  const ciro = (ev.cekCiro || 0) + (ev.cadirCiro || 0);
  const gider = (ev.agency || 0) + (ev.personnel || 0) + (ev.standCost || 0) + (ev.barter || 0);
  const kar = ciro - gider;
  const margin = ciro > 0 ? (kar / ciro) * 100 : 0;
  const roi = gider > 0 ? (kar / gider) * 100 : 0;
  const perCiro = ev.participants > 0 ? ciro / ev.participants : 0;
  const perGider = ev.participants > 0 ? gider / ev.participants : 0;
  return { ciro, gider, kar, margin, roi, perCiro, perGider };
}

// ============================================================
// FILTERS
// ============================================================
function getFilteredEvents() {
  const year = document.getElementById('year-filter').value;
  const city = document.getElementById('city-filter').value;
  return allEvents.filter(e => {
    if (year !== 'all' && e.year != parseInt(year)) return false;
    if (city !== 'all' && e.city !== city) return false;
    return true;
  });
}

function populateCityFilter() {
  const cities = [...new Set(allEvents.map(e => e.city))].sort();
  const sel = document.getElementById('city-filter');
  sel.innerHTML = '<option value="all">T√ºm ≈ûehirler</option>';
  cities.forEach(c => {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    sel.appendChild(o);
  });
}

function applyFilters() {
  updateDashboard();
  renderEventsTable();
  renderAnalysis();
  renderWeatherTable();
}

// ============================================================
// FORMAT
// ============================================================
function fCur(n) {
  if (Math.abs(n) >= 1000000) return '‚Ç∫' + (n/1000000).toFixed(1) + 'M';
  if (Math.abs(n) >= 1000) return '‚Ç∫' + (n/1000).toFixed(0) + 'K';
  return '‚Ç∫' + Math.round(n).toLocaleString('tr-TR');
}

function fNum(n) { return Math.round(n).toLocaleString('tr-TR'); }
function fPct(n) { return (n >= 0 ? '+' : '') + n.toFixed(1) + '%'; }

// ============================================================
// DASHBOARD
// ============================================================
function updateDashboard() {
  const evs = getFilteredEvents();
  const metrics = evs.map(e => ({ ...e, ...compute(e) }));

  const totalCiro = metrics.reduce((a,b) => a + b.ciro, 0);
  const totalGider = metrics.reduce((a,b) => a + b.gider, 0);
  const totalKar = metrics.reduce((a,b) => a + b.kar, 0);
  const avgMargin = metrics.filter(m => m.ciro > 0).reduce((a,b) => a + b.margin, 0) / Math.max(1, metrics.filter(m=>m.ciro>0).length);
  const avgROI = metrics.filter(m => m.gider > 0).reduce((a,b) => a + b.roi, 0) / Math.max(1, metrics.filter(m=>m.gider>0).length);

  document.getElementById('kpi-ciro').textContent = fCur(totalCiro);
  document.getElementById('kpi-kar').textContent = fCur(totalKar);
  document.getElementById('kpi-gider').textContent = fCur(totalGider);
  document.getElementById('kpi-margin').textContent = avgMargin.toFixed(1) + '%';
  document.getElementById('kpi-count').textContent = evs.length;
  document.getElementById('kpi-roi').textContent = avgROI.toFixed(1) + '%';

  const positiveMarginEvs = metrics.filter(m => m.ciro > 0);
  if (positiveMarginEvs.length > 0) {
    const best = positiveMarginEvs.reduce((a,b) => a.kar > b.kar ? a : b);
    const worst = positiveMarginEvs.reduce((a,b) => a.kar < b.kar ? a : b);
    document.getElementById('kpi-best').textContent = best.name.substring(0,20);
    document.getElementById('kpi-best-val').innerHTML = `<span class="kpi-badge badge-pos">${fCur(best.kar)} kar</span>`;
    document.getElementById('kpi-worst').textContent = worst.name.substring(0,20);
    document.getElementById('kpi-worst-val').innerHTML = `<span class="kpi-badge badge-neg">${fCur(worst.kar)}</span>`;
  }

  const karPct = totalCiro > 0 ? (totalKar/totalCiro)*100 : 0;
  document.getElementById('kpi-ciro-badge').textContent = `√áek: ${fCur(metrics.reduce((a,b)=>a+b.cekCiro,0))} + √áadƒ±r: ${fCur(metrics.reduce((a,b)=>a+b.cadirCiro,0))}`;
  document.getElementById('kpi-kar-badge').textContent = `Marj: ${karPct.toFixed(1)}%`;

  updateCharts(metrics);
}

// ============================================================
// CHARTS
// ============================================================
const CHART_DEFAULTS = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { labels: { color: '#8da0bf', font: { family: 'DM Mono', size: 10 }, boxWidth: 10 } },
    tooltip: {
      backgroundColor: '#1a2438',
      borderColor: '#3b82f6',
      borderWidth: 1,
      titleColor: '#f0f4ff',
      bodyColor: '#8da0bf',
      padding: 10,
    }
  },
  scales: {
    x: { grid: { color: 'rgba(59,130,246,0.06)' }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 } } },
    y: { grid: { color: 'rgba(59,130,246,0.06)' }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 }, callback: v => '‚Ç∫' + (Math.abs(v)>=1000000 ? (v/1000000).toFixed(1)+'M' : Math.abs(v)>=1000 ? (v/1000).toFixed(0)+'K' : v) } }
  }
};

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function updateCharts(metrics) {
  // Monthly trend
  const monthMap = {};
  const MONTHS = ['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  metrics.forEach(e => {
    if (!e.date) return;
    const d = new Date(e.date);
    if (isNaN(d)) return;
    const key = e.year + '-' + String(d.getMonth()).padStart(2,'0');
    if (!monthMap[key]) monthMap[key] = { label: MONTHS[d.getMonth()] + ' ' + e.year, ciro: 0, kar: 0 };
    monthMap[key].ciro += e.ciro;
    monthMap[key].kar += e.kar;
  });

  const monthKeys = Object.keys(monthMap).sort();
  const monthLabels = monthKeys.map(k => monthMap[k].label);
  const monthCiro = monthKeys.map(k => monthMap[k].ciro);
  const monthKar = monthKeys.map(k => monthMap[k].kar);

  destroyChart('monthly');
  charts.monthly = new Chart(document.getElementById('chartMonthly'), {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [
        { label: 'Ciro', data: monthCiro, backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 4, order: 2 },
        { label: 'Kar', data: monthKar, type: 'line', borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', borderWidth: 2, pointRadius: 3, tension: 0.4, order: 1, fill: true }
      ]
    },
    options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins } }
  });

  // City ROI
  const cityMap = {};
  metrics.forEach(e => {
    if (!cityMap[e.city]) cityMap[e.city] = { kar: 0, gider: 0, count: 0 };
    cityMap[e.city].kar += e.kar;
    cityMap[e.city].gider += e.gider;
    cityMap[e.city].count++;
  });

  const cities = Object.keys(cityMap).filter(c => cityMap[c].gider > 0);
  const cityROI = cities.map(c => cityMap[c].gider > 0 ? (cityMap[c].kar / cityMap[c].gider) * 100 : 0);
  const cityColors = cityROI.map(r => r >= 0 ? 'rgba(16,185,129,0.7)' : 'rgba(244,63,94,0.7)');

  destroyChart('cityROI');
  charts.cityROI = new Chart(document.getElementById('chartCityROI'), {
    type: 'bar',
    data: {
      labels: cities,
      datasets: [{ label: 'ROI %', data: cityROI, backgroundColor: cityColors, borderRadius: 4 }]
    },
    options: {
      ...CHART_DEFAULTS,
      indexAxis: 'y',
      scales: {
        x: { ...CHART_DEFAULTS.scales.x, ticks: { ...CHART_DEFAULTS.scales.x.ticks, callback: v => v.toFixed(0) + '%' } },
        y: { ...CHART_DEFAULTS.scales.y }
      }
    }
  });

  // Event Profitability (top 10)
  const top = metrics.filter(m => m.ciro > 0).sort((a,b) => b.ciro - a.ciro).slice(0, 10);
  destroyChart('eventProfit');
  charts.eventProfit = new Chart(document.getElementById('chartEventProfit'), {
    type: 'bar',
    data: {
      labels: top.map(e => e.name.substring(0,15) + (e.name.length > 15 ? '‚Ä¶' : '')),
      datasets: [
        { label: 'Ciro', data: top.map(e => e.ciro), backgroundColor: 'rgba(59,130,246,0.5)', borderRadius: 3 },
        { label: 'Gider', data: top.map(e => e.gider), backgroundColor: 'rgba(244,63,94,0.5)', borderRadius: 3 },
        { label: 'Kar', data: top.map(e => e.kar), backgroundColor: 'rgba(16,185,129,0.7)', borderRadius: 3 }
      ]
    },
    options: { ...CHART_DEFAULTS }
  });

  // Expense Breakdown
  const totalAgency = metrics.reduce((a,b) => a + (b.agency||0), 0);
  const totalPersonnel = metrics.reduce((a,b) => a + (b.personnel||0), 0);
  const totalStand = metrics.reduce((a,b) => a + (b.standCost||0), 0);
  const totalBarter = metrics.reduce((a,b) => a + (b.barter||0), 0);

  destroyChart('expense');
  charts.expense = new Chart(document.getElementById('chartExpense'), {
    type: 'doughnut',
    data: {
      labels: ['Ajans Bedeli', 'Personel', 'Stand Maliyeti', 'Barter'],
      datasets: [{
        data: [totalAgency, totalPersonnel, totalStand, totalBarter],
        backgroundColor: ['rgba(59,130,246,0.8)', 'rgba(139,92,246,0.8)', 'rgba(245,158,11,0.8)', 'rgba(34,211,238,0.8)'],
        borderWidth: 0,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { color: '#8da0bf', font: { family: 'DM Mono', size: 9 }, boxWidth: 10, padding: 12 } },
        tooltip: CHART_DEFAULTS.plugins.tooltip
      }
    }
  });
}

// ============================================================
// EVENTS TABLE
// ============================================================
function renderEventsTable(search = '') {
  const evs = getFilteredEvents();
  const tbody = document.getElementById('events-table-body');
  document.getElementById('event-count-badge').textContent = `(${evs.length})`;
  tbody.innerHTML = '';

  evs.filter(e => !search || e.name.toLowerCase().includes(search.toLowerCase()) || e.city.toLowerCase().includes(search.toLowerCase()))
    .forEach(ev => {
      const m = compute(ev);
      const perf = m.margin >= 40 ? 'high' : m.margin >= 0 ? 'mid' : 'low';
      const perfLabel = perf === 'high' ? 'Y√ºksek' : perf === 'mid' ? 'Orta' : 'D√º≈ü√ºk';
      const tr = document.createElement('tr');
      tr.onclick = () => showModal(ev);
      tr.innerHTML = `
        <td class="name-col">${ev.name}</td>
        <td>${ev.date || '‚Äî'}</td>
        <td>${ev.city}</td>
        <td class="num">${ev.participants > 0 ? fNum(ev.participants) : '‚Äî'}</td>
        <td class="num ${m.ciro > 0 ? 'pos' : ''}">${fCur(m.ciro)}</td>
        <td class="num">${fCur(m.gider)}</td>
        <td class="num ${m.kar >= 0 ? 'pos' : 'neg'}">${fCur(m.kar)}</td>
        <td class="num ${m.margin >= 0 ? 'pos' : 'neg'}">${m.ciro > 0 ? m.margin.toFixed(1) + '%' : '‚Äî'}</td>
        <td class="num ${m.roi >= 0 ? 'pos' : 'neg'}">${m.gider > 0 ? m.roi.toFixed(0) + '%' : '‚Äî'}</td>
        <td class="num">${ev.participants > 0 && m.ciro > 0 ? fCur(m.perCiro) : '‚Äî'}</td>
        <td class="num">${ev.participants > 0 && m.gider > 0 ? fCur(m.perGider) : '‚Äî'}</td>
        <td><span class="pill pill-${perf}">${perfLabel}</span></td>
      `;
      tbody.appendChild(tr);
    });

  if (tbody.children.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12"><div class="empty-state">Etkinlik bulunamadƒ±</div></td></tr>';
  }
}

function filterTable(v) { renderEventsTable(v); }

// ============================================================
// ANALYSIS
// ============================================================
function renderAnalysis() {
  const evs = getFilteredEvents();
  const metrics = evs.map(e => ({ ...e, ...compute(e) }));

  // City analysis
  const cityMap = {};
  metrics.forEach(e => {
    if (!cityMap[e.city]) cityMap[e.city] = { kar: 0, gider: 0, ciro: 0, count: 0 };
    cityMap[e.city].kar += e.kar;
    cityMap[e.city].gider += e.gider;
    cityMap[e.city].ciro += e.ciro;
    cityMap[e.city].count++;
  });

  const cities = Object.entries(cityMap).sort((a,b) => b[1].kar - a[1].kar);
  const maxKar = Math.max(...cities.map(c => Math.abs(c[1].kar)));

  const cityEl = document.getElementById('city-analysis');
  cityEl.innerHTML = cities.slice(0,8).map(([city, d]) => {
    const roi = d.gider > 0 ? (d.kar/d.gider)*100 : 0;
    const barPct = maxKar > 0 ? (Math.abs(d.kar) / maxKar) * 100 : 0;
    const color = d.kar >= 0 ? '#10b981' : '#f43f5e';
    return `<div class="insight-row">
      <span class="ir-label">${city}</span>
      <div class="ir-bar-wrap"><div class="ir-bar" style="width:${barPct}%;background:${color}"></div></div>
      <span class="ir-val">${fCur(d.kar)}</span>
    </div>`;
  }).join('');

  // Agency vs Margin scatter
  const agencyData = metrics.filter(m => m.agency > 0 && m.ciro > 0);
  destroyChart('agencyMargin');
  charts.agencyMargin = new Chart(document.getElementById('chartAgencyMargin'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Etkinlik',
        data: agencyData.map(m => ({ x: m.agency/1000, y: m.margin })),
        backgroundColor: 'rgba(59,130,246,0.6)',
        pointRadius: 5
      }]
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        x: { ...CHART_DEFAULTS.scales.x, title: { display: true, text: 'Ajans Bedeli (K‚Ç∫)', color: '#4d6080', font: { size: 9 } }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 }, callback: v => v + 'K' } },
        y: { ...CHART_DEFAULTS.scales.y, title: { display: true, text: 'Kar Marjƒ± %', color: '#4d6080', font: { size: 9 } }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 }, callback: v => v.toFixed(0) + '%' } }
      }
    }
  });

  // Participants vs ROI
  const partData = metrics.filter(m => m.participants > 0 && m.gider > 0);
  destroyChart('participantROI');
  charts.participantROI = new Chart(document.getElementById('chartParticipantROI'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Etkinlik',
        data: partData.map(m => ({ x: m.participants, y: m.roi })),
        backgroundColor: 'rgba(245,158,11,0.6)',
        pointRadius: 5
      }]
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        x: { ...CHART_DEFAULTS.scales.x, title: { display: true, text: 'Katƒ±lƒ±mcƒ± Sayƒ±sƒ±', color: '#4d6080', font: { size: 9 } }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 } } },
        y: { ...CHART_DEFAULTS.scales.y, title: { display: true, text: 'ROI %', color: '#4d6080', font: { size: 9 } }, ticks: { color: '#4d6080', font: { family: 'DM Mono', size: 9 }, callback: v => v.toFixed(0) + '%' } }
      }
    }
  });

  // Decision support
  const bestCity = cities[0];
  const profitableCount = metrics.filter(m => m.kar > 0 && m.ciro > 0).length;
  const avgAgency = metrics.filter(m => m.agency > 0).reduce((a,b) => a + b.agency, 0) / Math.max(1, metrics.filter(m=>m.agency>0).length);

  document.getElementById('decision-support').innerHTML = `
    <div style="background:rgba(16,185,129,0.07);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:16px">
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent-emerald);letter-spacing:1px;margin-bottom:8px">üèÜ EN KARLI ≈ûEHƒ∞R</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--text-primary)">${bestCity ? bestCity[0] : '‚Äî'}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px">${bestCity ? fCur(bestCity[1].kar) + ' toplam kar | ' + bestCity[1].count + ' etkinlik' : '‚Äî'}</div>
    </div>
    <div style="background:rgba(59,130,246,0.07);border:1px solid rgba(59,130,246,0.2);border-radius:10px;padding:16px">
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent-glow);letter-spacing:1px;margin-bottom:8px">üìà KARLILILIK ORANI</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--text-primary)">${metrics.length > 0 ? ((profitableCount/metrics.filter(m=>m.ciro>0).length)*100).toFixed(0) + '%' : '‚Äî'}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px">${profitableCount} / ${metrics.filter(m=>m.ciro>0).length} etkinlik k√¢rlƒ±</div>
    </div>
    <div style="background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:16px">
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent-amber);letter-spacing:1px;margin-bottom:8px">üí° ORT. AJANS MALƒ∞YETƒ∞</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--text-primary)">${fCur(avgAgency)}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Etkinlik ba≈üƒ±na ortalama</div>
    </div>
  `;

  // Weather analysis
  const withWeather = metrics.filter(m => m.weather && m.weather.trim());
  if (withWeather.length > 0) {
    const weatherEl = document.getElementById('weather-analysis');
    const byCondition = {};
    withWeather.forEach(m => {
      const cond = parseWeather(m.weather).condition || 'Bilinmiyor';
      if (!byCondition[cond]) byCondition[cond] = [];
      byCondition[cond].push(m.roi);
    });
    weatherEl.innerHTML = Object.entries(byCondition).map(([cond, rois]) => {
      const avgROI = rois.reduce((a,b)=>a+b,0)/rois.length;
      return `<div class="insight-row">
        <span class="ir-label">${cond}</span>
        <span class="ir-val ${avgROI >= 0 ? 'pos' : 'neg'}">${avgROI.toFixed(0)}% ROI</span>
      </div>`;
    }).join('');
  }
}

// ============================================================
// WEATHER TABLE
// ============================================================
function renderWeatherTable() {
  const evs = allEvents.filter(e => e.weather && e.weather.trim());
  const tbody = document.getElementById('weather-table-body');
  tbody.innerHTML = '';
  if (evs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state">Hen√ºz hava durumu verisi yok. Etkinlik eklerken Gemini yanƒ±tƒ±nƒ± yapƒ±≈ütƒ±rƒ±n.</div></td></tr>';
    return;
  }
  evs.forEach(ev => {
    const m = compute(ev);
    const w = parseWeather(ev.weather);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="name-col">${ev.name}</td>
      <td>${ev.date || '‚Äî'}</td>
      <td>${ev.city}</td>
      <td class="num">${w.temp || '‚Äî'}</td>
      <td>${w.condition || '‚Äî'}</td>
      <td class="num">${w.wind || '‚Äî'}</td>
      <td class="num ${m.kar >= 0 ? 'pos' : 'neg'}">${fCur(m.kar)}</td>
      <td>${getWeatherImpact(w, m)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function parseWeather(str) {
  if (!str) return {};
  const temp = (str.match(/sƒ±caklƒ±k:\s*([\d.]+)/i) || [])[1];
  const cond = (str.match(/durum:\s*(\S+(?:\s+\S+)?)/i) || [])[1];
  const wind = (str.match(/r√ºzgar:\s*([\d.]+)/i) || [])[1];
  return { temp: temp ? temp + '¬∞C' : null, condition: cond, wind: wind ? wind + ' km/h' : null };
}

function getWeatherImpact(w, m) {
  if (!w.condition) return '‚Äî';
  const cond = w.condition.toLowerCase();
  if (m.roi > 100 && (cond.includes('g√ºne≈ü') || cond.includes('a√ßƒ±k'))) return '<span class="pill pill-high">‚Üë Olumlu</span>';
  if (cond.includes('yaƒümur') && m.roi < 0) return '<span class="pill pill-low">‚Üì Olumsuz</span>';
  return '<span class="pill pill-mid">‚Üí N√∂tr</span>';
}

// ============================================================
// FORM / NEW EVENT
// ============================================================
function calcPreview() {
  const cek = parseFloat(document.getElementById('f-cek').value) || 0;
  const cadir = parseFloat(document.getElementById('f-cadirciro').value) || 0;
  const ajans = parseFloat(document.getElementById('f-ajans').value) || 0;
  const per = parseFloat(document.getElementById('f-personel').value) || 0;
  const stand = parseFloat(document.getElementById('f-stand').value) || 0;
  const barter = parseFloat(document.getElementById('f-barter').value) || 0;
  const katilimci = parseFloat(document.getElementById('f-katilimci').value) || 0;

  const ciro = cek + cadir;
  const gider = ajans + per + stand + barter;
  const kar = ciro - gider;
  const margin = ciro > 0 ? (kar/ciro)*100 : 0;
  const roi = gider > 0 ? (kar/gider)*100 : 0;

  document.getElementById('p-ciro').textContent = fCur(ciro);
  document.getElementById('p-gider').textContent = fCur(gider);

  const karEl = document.getElementById('p-kar');
  karEl.textContent = fCur(kar);
  karEl.style.color = kar >= 0 ? 'var(--accent-emerald)' : 'var(--accent-rose)';

  document.getElementById('p-margin').textContent = ciro > 0 ? margin.toFixed(1) + '%' : '‚Äî';
  document.getElementById('p-roi').textContent = gider > 0 ? roi.toFixed(1) + '%' : '‚Äî';
  document.getElementById('p-perciro').textContent = katilimci > 0 && ciro > 0 ? fCur(ciro/katilimci) : '‚Äî';
  document.getElementById('p-pergider').textContent = katilimci > 0 && gider > 0 ? fCur(gider/katilimci) : '‚Äî';

  fetchWeather();
}

function fetchWeather() {
  const date = document.getElementById('f-date').value;
  const city = document.getElementById('f-city').value;
  if (!date || !city) return;

  const d = new Date(date);
  const months = ['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
  const formatted = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;

  const prompt = `${formatted} tarihinde ${city}'de hava nasƒ±ldƒ±?\nSadece ≈üu formatta cevap ver:\nSƒ±caklƒ±k: X¬∞C\nDurum: G√ºne≈üli/Yaƒümurlu/Bulutlu\nR√ºzgar: X km/h`;
  document.getElementById('weather-prompt').textContent = prompt;
  document.getElementById('weather-result').style.display = 'block';
}

function saveEvent() {
  const name = document.getElementById('f-name').value.trim();
  const date = document.getElementById('f-date').value;
  const city = document.getElementById('f-city').value.trim();

  if (!name || !city) { showToast('Etkinlik adƒ± ve ≈üehir zorunludur'); return; }

  const ev = {
    id: nextId++,
    name,
    date,
    city,
    participants: parseFloat(document.getElementById('f-katilimci').value) || 0,
    tents: parseFloat(document.getElementById('f-cadƒ±r').value) || 0,
    agency: parseFloat(document.getElementById('f-ajans').value) || 0,
    personnel: parseFloat(document.getElementById('f-personel').value) || 0,
    standCost: parseFloat(document.getElementById('f-stand').value) || 0,
    barter: parseFloat(document.getElementById('f-barter').value) || 0,
    cekCiro: parseFloat(document.getElementById('f-cek').value) || 0,
    cadirCiro: parseFloat(document.getElementById('f-cadirciro').value) || 0,
    year: parseInt(document.getElementById('f-year').value),
    weather: document.getElementById('f-weather').value.trim()
  };

  allEvents.push(ev);
  populateCityFilter();
  applyFilters();
  showToast('‚úì Etkinlik kaydedildi: ' + name);
  clearForm();
  showPage('events', document.querySelectorAll('.nav-item')[1]);
}

function clearForm() {
  ['f-name','f-date','f-city','f-katilimci','f-cadƒ±r','f-ajans','f-personel','f-stand','f-barter','f-cek','f-cadirciro','f-weather'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  calcPreview();
}

// ============================================================
// MODAL
// ============================================================
function showModal(ev) {
  const m = compute(ev);
  document.getElementById('modal-event-name').textContent = ev.name;
  document.getElementById('modal-overlay').classList.add('open');

  const w = parseWeather(ev.weather);

  document.getElementById('modal-body').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      ${[
        ['≈ûehir', ev.city],
        ['Tarih', ev.date || '‚Äî'],
        ['Katƒ±lƒ±mcƒ±', ev.participants > 0 ? fNum(ev.participants) : '‚Äî'],
        ['√áadƒ±r Sayƒ±sƒ±', ev.tents || '‚Äî'],
        ['Yƒ±l', ev.year],
        ['ID', '#' + ev.id]
      ].map(([l,v]) => `
        <div style="background:var(--bg-elevated);border-radius:8px;padding:12px">
          <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px">${l}</div>
          <div style="font-weight:600;color:var(--text-primary)">${v}</div>
        </div>`
      ).join('')}
    </div>

    <div style="background:var(--bg-elevated);border-radius:10px;padding:14px;margin-bottom:12px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--accent-primary);letter-spacing:1px;margin-bottom:10px">Gƒ∞DER KALEMLERƒ∞</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
        <div><span style="color:var(--text-muted)">Ajans Bedeli: </span><span style="color:var(--text-primary);font-family:'DM Mono',monospace">${fCur(ev.agency||0)}</span></div>
        <div><span style="color:var(--text-muted)">Personel: </span><span style="color:var(--text-primary);font-family:'DM Mono',monospace">${fCur(ev.personnel||0)}</span></div>
        <div><span style="color:var(--text-muted)">Stand Maliyeti: </span><span style="color:var(--text-primary);font-family:'DM Mono',monospace">${fCur(ev.standCost||0)}</span></div>
        <div><span style="color:var(--text-muted)">Barter: </span><span style="color:var(--text-primary);font-family:'DM Mono',monospace">${fCur(ev.barter||0)}</span></div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
      ${[
        ['Toplam Ciro', fCur(m.ciro), 'var(--accent-glow)'],
        ['Toplam Gider', fCur(m.gider), 'var(--accent-amber)'],
        ['Net Kar', fCur(m.kar), m.kar >= 0 ? 'var(--accent-emerald)' : 'var(--accent-rose)'],
        ['Kar Marjƒ±', m.ciro > 0 ? m.margin.toFixed(1)+'%' : '‚Äî', 'var(--text-primary)'],
        ['ROI', m.gider > 0 ? m.roi.toFixed(0)+'%' : '‚Äî', m.roi >= 0 ? 'var(--accent-emerald)' : 'var(--accent-rose)'],
        ['Kat. Ba≈üƒ± Ciro', ev.participants > 0 ? fCur(m.perCiro) : '‚Äî', 'var(--text-primary)'],
      ].map(([l,v,c]) => `
        <div style="background:var(--bg-elevated);border-radius:8px;padding:12px;text-align:center">
          <div style="font-family:'DM Mono',monospace;font-size:8px;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px">${l}</div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:${c}">${v}</div>
        </div>`
      ).join('')}
    </div>

    ${ev.weather ? `<div style="background:rgba(59,130,246,0.07);border:1px solid rgba(59,130,246,0.15);border-radius:8px;padding:12px">
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--accent-primary);letter-spacing:1px;margin-bottom:6px">HAVA DURUMU</div>
      <div style="font-size:12px;color:var(--text-secondary);font-family:'DM Mono',monospace;white-space:pre-line">${ev.weather}</div>
    </div>` : ''}
  `;
}

function closeModal(event) {
  if (!event || event.target === document.getElementById('modal-overlay')) {
    document.getElementById('modal-overlay').classList.remove('open');
  }
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(id, navItem) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navItem) navItem.classList.add('active');

  const titles = {
    dashboard: 'Dashboard ‚Äî Genel Bakƒ±≈ü',
    events: 'Etkinlikler ‚Äî T√ºm Kayƒ±tlar',
    'new-event': 'Yeni Etkinlik Ekle',
    analysis: 'Analiz Motoru ‚Äî Karar Destek',
    weather: 'Hava Durumu ‚Äî Gemini Entegrasyonu'
  };
  document.getElementById('page-title').textContent = titles[id] || '';

  if (id === 'events') renderEventsTable();
  if (id === 'analysis') renderAnalysis();
  if (id === 'weather') renderWeatherTable();
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ============================================================
// EXPORT
// ============================================================
function exportCSV() {
  const evs = getFilteredEvents();
  const headers = ['Etkinlik','Tarih','≈ûehir','Katƒ±lƒ±mcƒ±','Ajans','Personel','Stand','Barter','√áekCiro','√áadƒ±rCiro','ToplamCiro','ToplamGider','NetKar','KarMarjƒ±%','ROI%','KatBa≈üƒ±Ciro','KatBa≈üƒ±Maliyet'];
  const rows = evs.map(ev => {
    const m = compute(ev);
    return [ev.name, ev.date, ev.city, ev.participants, ev.agency, ev.personnel, ev.standCost, ev.barter, ev.cekCiro, ev.cadirCiro,
      m.ciro.toFixed(0), m.gider.toFixed(0), m.kar.toFixed(0), m.margin.toFixed(1), m.roi.toFixed(1),
      m.perCiro.toFixed(0), m.perGider.toFixed(0)].join(',');
  });

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'spx_etkinlik_analizi.csv'; a.click();
  showToast('CSV indirildi');
}

// ============================================================
// INIT
// ============================================================
function init() {
  populateCityFilter();
  updateDashboard();
  renderEventsTable();
}

init();
</script>
</body>
</html>
